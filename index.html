<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Vault – Premium Video Content</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --dark: #111827;
      --light: #f9fafb;
      --gray: #6b7280;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.6;
    }

    header {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    nav {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo { font-size: 1.75rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 0.75rem; }
    .logo img { height: 48px; width: auto; }

    .cart-icon { position: relative; cursor: pointer; font-size: 1.5rem; }
    .cart-count {
      position: absolute; top: -8px; right: -12px; background: var(--primary); color: white;
      font-size: 0.75rem; font-weight: bold; width: 22px; height: 22px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }

    main { max-width: 1400px; margin: 3rem auto; padding: 0 1.5rem; }
    h1 { text-align: center; margin-bottom: 2.5rem; font-size: 2.5rem; }

    .filters {
      max-width: 1200px; margin: 0 auto 2rem; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;
    }
    .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .filter-group label { font-weight: 600; color: var(--dark); }
    select {
      padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; min-width: 220px;
    }

    .products-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem;
    }

    .product-card {
      background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .product-card:hover {
      transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }

    .product-thumbnail { width: 100%; height: 180px; object-fit: cover; background: #e5e7eb; }
    .product-info { padding: 1.25rem; }
    .product-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
    .product-desc { color: var(--gray); font-size: 0.95rem; margin-bottom: 1rem; }
    .product-price { font-size: 1.5rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 1rem; }
    .product-lang { font-size: 0.9rem; color: #4b5563; margin-bottom: 0.75rem; font-style: italic; }

    .btn {
      padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 6px;
      font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .btn:hover { background: var(--primary-dark); }
    .btn-preview { background: #6b7280; margin-right: 0.5rem; }
    .btn-preview:hover { background: #4b5563; }

    /* Modals */
    .modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
      justify-content: center; align-items: center; padding: 1rem;
    }
    .modal-content {
      background: white; width: 90%; max-width: 800px; border-radius: 12px; overflow: auto; position: relative; max-height: 90vh;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;
      position: sticky; top: 0; background: white; z-index: 1;
    }
    .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--gray); }

    video { width: 100%; display: block; }
    #preview-video { max-height: 55vh; object-fit: contain; background: #000; }

    /* Cart Modal */
    #cart-modal .modal-content { max-width: 500px; }
    #cart-items { padding: 1rem 1.5rem 0; }
    .cart-item { display:flex; justify-content:space-between; gap:1rem; padding:0.75rem 0; border-bottom: 1px solid #f3f4f6; }
    .empty-cart { padding: 1rem 1.5rem; color: var(--gray); }
    .cart-total { padding: 1rem 1.5rem; font-weight: 700; display:flex; justify-content: space-between; }
    .btn[disabled] { opacity: 0.6; cursor: not-allowed; }
    .checkout-note { padding: 0 1.5rem 1.25rem; font-size: 0.9rem; color: var(--gray); }

    @media (max-width: 600px) {
      .products-grid { grid-template-columns: 1fr; }
      .filters { flex-direction: column; align-items: center; }
    }
  </style>
</head>
<body>

  <header>
    <nav>
      <div class="logo">
        <img src="https://via.placeholder.com/48x48/6366f1/ffffff?text=VV" alt="Video Vault Logo">
        Video Vault
      </div>
      <div class="cart-icon" onclick="openCart()">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count" id="cart-count">0</span>
      </div>
    </nav>
  </header>

  <main>
    <h1>Premium Video Collection</h1>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="langFilter">Filter by Language Pair</label>
        <select id="langFilter" onchange="applyFilters()">
          <option value="">All Languages</option>
          <option value="English to French">English to French</option>
          <option value="French to English">French to English</option>
          <option value="English to Spanish">English to Spanish</option>
          <option value="Spanish to English">Spanish to English</option>
          <option value="English to German">English to German</option>
          <option value="German to English">German to English</option>
        </select>
      </div>
    </div>

    <div class="products-grid" id="products-container"></div>
  </main>

  <!-- Video Preview Modal -->
  <div id="preview-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="preview-title">Video Preview</h2>
        <button class="close-btn" onclick="closePreview()">×</button>
      </div>
      <video id="preview-video" controls autoplay muted>
        <source id="preview-source" src="" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <div style="padding: 1rem 1.5rem 1.5rem;">
        <div id="preview-no-video" style="display:none; color: var(--gray); margin-bottom: 0.75rem;">
          No preview video available for this course.
        </div>
        <div style="font-weight: 700; margin-bottom: 0.5rem;">Sample content</div>
        <div id="preview-text" style="white-space: pre-wrap; color: #374151;"></div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Your Cart</h2>
        <button class="close-btn" onclick="closeCart()">×</button>
      </div>
      <div id="cart-items"></div>
      <div class="cart-total">
        Total: <span id="cart-total">$0.00</span>
      </div>
      <button class="btn" id="checkout-btn" style="width:100%; margin: 0 1.5rem 0.75rem;" onclick="startCheckout()">
        Proceed to Checkout
      </button>
      <div class="checkout-note">You’ll be redirected to Stripe to complete payment.</div>
    </div>
  </div>

  <script>
    const STRIPE_CHECKOUT_ENDPOINT = "https://gzob52iqr5.execute-api.us-east-1.amazonaws.com/prod/stripe";
    const CONTENT_MARKET_LIST_ENDPOINT = "https://gzob52iqr5.execute-api.us-east-1.amazonaws.com/prod/content-market-list-data";
    const CONTENT_MARKET_SHOW_META_URL_ENDPOINT = "https://gzob52iqr5.execute-api.us-east-1.amazonaws.com/prod/content-market-show-meta-url";
    const PURCHASE_STORAGE_KEY = "golingo_content_market_purchase_v1";
    const DEFAULT_COURSE_PRICE_USD = 1.00;

    let courses = [];
    let cart = [];
    const metaUrlCache = new Map();

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (ch) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#039;"
      }[ch]));
    }

    function truncate(str, max = 140) {
      const s = String(str ?? "");
      if (s.length <= max) return s;
      return `${s.slice(0, max - 1)}…`;
    }

    function makeCourseThumbnailDataUrl(courseName) {
      const safeName = escapeHtml(courseName || "Course");
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="500" viewBox="0 0 800 500">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#6366f1"/>
              <stop offset="100%" stop-color="#22c55e"/>
            </linearGradient>
          </defs>
          <rect width="800" height="500" fill="url(#g)"/>
          <rect x="40" y="40" width="720" height="420" rx="24" fill="rgba(17,24,39,0.25)"/>
          <text x="80" y="230" fill="white" font-size="44" font-family="system-ui, -apple-system, Segoe UI, Roboto, sans-serif" font-weight="800">
            ${safeName}
          </text>
          <text x="80" y="285" fill="rgba(255,255,255,0.9)" font-size="22" font-family="system-ui, -apple-system, Segoe UI, Roboto, sans-serif">
            Golingo content preview
          </text>
        </svg>
      `.trim();

      return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
    }

    function normalizeListResponse(data) {
      if (data?.body) {
        if (Array.isArray(data.body)) return data.body;
        if (typeof data.body === "string") {
          try {
            const parsed = JSON.parse(data.body);
            return Array.isArray(parsed) ? parsed : [];
          } catch {
            return [];
          }
        }
      }
      if (Array.isArray(data)) return data;
      return [];
    }

    function parseCourseContent(raw) {
      if (!raw) return null;
      if (typeof raw === "object") return raw;
      if (typeof raw !== "string") return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function normalizeMetaUrlResponse(data) {
      let payload = data ?? {};
      if (typeof data?.body === "string") {
        try { payload = JSON.parse(data.body); } catch { payload = {}; }
      } else if (data?.body && typeof data.body === "object") {
        payload = data.body;
      }

      const imageUrl = typeof payload?.image_url === "string" && payload.image_url ? payload.image_url : "";
      const videoUrl = typeof payload?.video_url === "string" && payload.video_url ? payload.video_url : "";
      return { imageUrl, videoUrl };
    }

    async function fetchCourseMetaUrls(courseId) {
      const key = String(courseId ?? "");
      if (!key) return { imageUrl: "", videoUrl: "" };
      if (metaUrlCache.has(key)) return metaUrlCache.get(key);

      const promise = (async () => {
        try {
          const res = await fetch(CONTENT_MARKET_SHOW_META_URL_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ course_id: key })
          });

          if (!res.ok) return { imageUrl: "", videoUrl: "" };
          const data = await res.json();
          return normalizeMetaUrlResponse(data);
        } catch (err) {
          console.warn("Failed to load meta urls", { courseId: key, err });
          return { imageUrl: "", videoUrl: "" };
        }
      })();

      metaUrlCache.set(key, promise);
      return promise;
    }

    function toCourse(item, index) {
      const courseName = item?.course_name ?? item?.courseName ?? `Course ${index + 1}`;
      const courseId = item?.course_id ?? item?.courseId ?? item?.id ?? String(index + 1);
      const rawContent = item?.content ?? null;
      const parsedContent = parseCourseContent(rawContent);
      const first = parsedContent?.contents?.[0] ?? null;
      const previewVideoUrl = first?.mVideoUrl ?? "";
      const previewText = first?.mContent ?? "";
      const description = previewText ? truncate(previewText, 160) : "Includes lessons, translations, and video content.";

      return {
        courseId,
        courseName,
        price: DEFAULT_COURSE_PRICE_USD,
        thumbnail: makeCourseThumbnailDataUrl(courseName),
        metaImageUrl: "",
        metaVideoUrl: "",
        languagePair: courseName,
        description,
        previewVideoUrl,
        previewText,
        rawContent,
        parsedContent,
      };
    }

    function renderProducts(filteredCourses = courses) {
      const container = document.getElementById("products-container");
      container.innerHTML = "";

      if (!filteredCourses.length) {
        container.innerHTML = '<div style="grid-column: 1 / -1; color: var(--gray); text-align: center;">No courses found.</div>';
        return;
      }

      filteredCourses.forEach(course => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${course.metaImageUrl || course.thumbnail}" alt="${escapeHtml(course.courseName)}" class="product-thumbnail" loading="lazy">
          <div class="product-info">
            <h3 class="product-title">${escapeHtml(course.courseName)}</h3>
            <p class="product-lang">${escapeHtml(course.languagePair)}</p>
            <p class="product-desc">${escapeHtml(course.description)}</p>
            <div class="product-price">$${course.price.toFixed(2)}</div>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn-preview" data-action="preview">Preview</button>
              <button class="btn" data-action="add">Add to Cart</button>
            </div>
          </div>
        `;
        const img = card.querySelector("img.product-thumbnail");
        fetchCourseMetaUrls(course.courseId).then((meta) => {
          if (meta.imageUrl) course.metaImageUrl = meta.imageUrl;
          if (meta.videoUrl) course.metaVideoUrl = meta.videoUrl;
          if (img && card.isConnected && meta.imageUrl) img.src = meta.imageUrl;
        });

        const previewBtn = card.querySelector('[data-action="preview"]');
        previewBtn?.addEventListener("click", async () => {
          if (!course.metaVideoUrl) {
            const meta = await fetchCourseMetaUrls(course.courseId);
            if (meta.imageUrl) course.metaImageUrl = meta.imageUrl;
            if (meta.videoUrl) course.metaVideoUrl = meta.videoUrl;
          }
          openPreview(course.courseName, course.metaVideoUrl || course.previewVideoUrl, course.previewText);
        });
        const addBtn = card.querySelector('[data-action="add"]');
        addBtn?.addEventListener("click", () => addToCart(course.courseId));
        container.appendChild(card);
      });
    }

    // Preview Modal
    let previewStopHandler = null;

    function openPreview(title, videoUrl, previewText) {
      const video = document.getElementById("preview-video");
      document.getElementById("preview-title").textContent = `${title} – Preview`;
      document.getElementById("preview-text").textContent = previewText || "";

      const noVideoEl = document.getElementById("preview-no-video");
      if (!videoUrl) {
        noVideoEl.style.display = "block";
        document.getElementById("preview-source").src = "";
        video.load();
      } else {
        noVideoEl.style.display = "none";
        document.getElementById("preview-source").src = videoUrl;
        video.load();
      }

      if (previewStopHandler) {
        video.removeEventListener("timeupdate", previewStopHandler);
        previewStopHandler = null;
      }

      document.getElementById("preview-modal").style.display = "flex";

      // Play only the first 1 second (if possible).
      if (videoUrl) {
        const stopAtSeconds = 1;
        previewStopHandler = () => {
          if (video.currentTime >= stopAtSeconds) {
            video.pause();
            video.currentTime = 0;
            if (previewStopHandler) {
              video.removeEventListener("timeupdate", previewStopHandler);
              previewStopHandler = null;
            }
          }
        };
        video.currentTime = 0;
        video.addEventListener("timeupdate", previewStopHandler);
        video.play().catch(() => {});
      }
    }

    function closePreview() {
      document.getElementById("preview-modal").style.display = "none";
      const video = document.getElementById("preview-video");
      if (previewStopHandler) {
        video.removeEventListener("timeupdate", previewStopHandler);
        previewStopHandler = null;
      }
      video.pause();
    }

    // Filter by Language
    function applyFilters() {
      const langFilter = document.getElementById("langFilter").value;
      let filtered = courses;

      if (langFilter) {
        filtered = courses.filter(c => c.languagePair === langFilter);
      }

      renderProducts(filtered);
    }

    function populateLanguageFilter() {
      const select = document.getElementById("langFilter");
      const existingValue = select.value;

      const uniquePairs = Array.from(new Set(courses.map(c => c.languagePair).filter(Boolean))).sort((a, b) => a.localeCompare(b));
      select.innerHTML = "";

      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "All Languages";
      select.appendChild(allOpt);

      uniquePairs.forEach((pair) => {
        const opt = document.createElement("option");
        opt.value = pair;
        opt.textContent = pair;
        select.appendChild(opt);
      });

      if (existingValue && uniquePairs.includes(existingValue)) select.value = existingValue;
    }

    // Cart functions
    function addToCart(courseId) {
      const course = courses.find(c => String(c.courseId) === String(courseId));
      if (course) {
        if (cart.some(c => String(c.courseId) === String(course.courseId))) {
          alert("This course is already in your cart.");
          return;
        }
        cart.push(course);
        document.getElementById("cart-count").textContent = cart.length;
        alert(`${course.courseName} added to cart!`);
      }
    }

    function openCart() {
      const container = document.getElementById("cart-items");
      container.innerHTML = cart.length === 0 
        ? '<p class="empty-cart">Your cart is empty.</p>'
        : cart.map(item => `<div class="cart-item"><span>${escapeHtml(item.courseName)}</span><span>$${item.price.toFixed(2)}</span></div>`).join('');

      const total = cart.reduce((sum, item) => sum + item.price, 0);
      document.getElementById("cart-total").textContent = `$${total.toFixed(2)}`;

      document.getElementById("cart-modal").style.display = "flex";
    }

    function closeCart() {
      document.getElementById("cart-modal").style.display = "none";
    }

    async function startCheckout() {
      if (cart.length === 0) {
        alert("Your cart is empty.");
        return;
      }

      // Persist the cart so the success page can offer downloads.
      const purchasePayload = {
        createdAt: new Date().toISOString(),
        items: cart.map(c => ({
          course_id: c.courseId,
          course_name: c.courseName,
          content: c.parsedContent ?? c.rawContent
        }))
      };
      try { localStorage.setItem(PURCHASE_STORAGE_KEY, JSON.stringify(purchasePayload)); } catch {}

      const checkoutBtn = document.getElementById("checkout-btn");
      checkoutBtn.disabled = true;
      const previousText = checkoutBtn.textContent;
      checkoutBtn.textContent = "Redirecting to Stripe…";

      try {
        const res = await fetch(STRIPE_CHECKOUT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            items: cart.map(item => ({ id: item.courseId, title: item.courseName, price: item.price })),
            return_url_base: window.location.origin
          })
        });

        if (!res.ok) {
          throw new Error(`Stripe session request failed (${res.status})`);
        }

        const data = await res.json();
        if (typeof data?.statusCode === "number" && data.statusCode >= 400) {
          throw new Error(`Stripe session request failed (${data.statusCode})`);
        }

        let payload = data;
        if (typeof data?.body === "string") {
          try { payload = JSON.parse(data.body); } catch { payload = {}; }
        } else if (data?.body && typeof data.body === "object") {
          payload = data.body;
        }

        const url = payload?.url ?? data?.url;
        if (!url) {
          throw new Error("Stripe session response missing `url`.");
        }

        window.location.assign(url);
      } catch (err) {
        console.error(err);
        alert("Payment failed. Check console.");
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = previousText;
      }
    }

    // Initialize
    async function loadCoursesFromApi() {
      const container = document.getElementById("products-container");
      container.innerHTML = '<div style="grid-column: 1 / -1; color: var(--gray); text-align: center;">Loading courses…</div>';

      try {
        const res = await fetch(CONTENT_MARKET_LIST_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });

        if (!res.ok) throw new Error(`List request failed (${res.status})`);
        const data = await res.json();

        const list = normalizeListResponse(data);
        courses = list.map(toCourse).filter(c => c.courseId && c.courseName);
        populateLanguageFilter();
        renderProducts(courses);
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div style="grid-column: 1 / -1; color: var(--gray); text-align: center;">Failed to load courses. Check the console for details.</div>';
      }
    }

    loadCoursesFromApi();
  </script>
</body>
</html>
